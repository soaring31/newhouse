{% extends 'HouseBundle::base_manage_block.html.twig' %}
{% set user_id = app.user.id|default('') %}

{% set url_name = app.request.get('name') %}

{% set url_update_time = app.request.get('update_time') %}

{% set update_time_opt = url_update_time ? {
    update_time: 'lt|' ~ url_update_time
} : {} %}

{% block js %}
<script type="text/javascript">   
</script>
{% endblock %}

{% block mainMenu %}
    {{parent()}}
{% endblock %}

{% block tableMain %}
{{ core_manage.filter([
    {
        title: '结算时间',
        attr: {
            'data-selectdate': {
                unix: 1
            }
        },
        data: [
                {
                    id: '1M',
                    name: '一个月前'
                },
                {
                    id: '3M',
                    name: '三个月前'
                }
            ],
        field: 'update_time',
        method: 'selectFilter'
    },
    {
        size: 30,
        method: 'search',
        title: '请输入被推荐人电话/名称',
    }
]) }}
{# 下级经纪人 #}
{% set fx_jjr =  ('db.userinfo')|getCol('uid', {fxpid: user_id|default('')})|default('9999999999')|join(',') %}
{# 下级经纪人分销 #}
{% set fx_list = ('house.recommend')|getAll({ uid: 'in|' ~ fx_jjr|default(''), status: 4, _multi: 1, name: 'orX|name,like,%' ~ url_name ~ '%|tel,like,%' ~ url_name ~ '%', findType: 1 }|merge(update_time_opt)) %}


<section class="list-con" data-param="{
    defUrl    : '{{ (action)|U }}',
    showUrl   : '{{ (action ~ '/show')|U }}',
    submitUrl : '{{ (action ~ '/save')|U }}',
    deleteUrl : '{{ (action ~ '/delete')|U }}',
    fixed     : '.filter',
    list      : '.list-con',
    data      : {
    }
}">
    <div class="list">
        <table class="right-table table-hover">
            <tbody>
                <tr data-id>
                    <th width="50" class="tac">{{core_manage.checkbox()}}</th>
                    <th width="120">经纪人</th>
                    <th width="120">被推荐人姓名</th>
                    <th width="120">联系电话</th>
                    <th width="120">楼盘名称</th>
                    <th width="120">佣金(元)</th>
                    <th width="120">结算时间</th>
                    <th width="120">备注</th>
                </tr>
                {% if fx_list.data is defined and fx_list.pageCount|default(0) != 0 %}
                    {% for k, vo in fx_list.data %}
                        {# 楼盘id #}
                        {% set vo_houses = ('house.sell')|getOne('aid', {id: vo.aid|default('')}) %}
                        {% set user_nicename = ('db.userinfo')|getOne('nicename', {uid: vo.uid}) %}
                        {% set user_username = ('db.users')|getOne('username', {id: vo.uid}) %}
                        <tr data-id="{{ vo.id }}">
                            <td class="tac">{{core_manage.checkbox()}}</td>
                            <td >{{ user_nicename|default(user_username|default('-')) }}</td>
                            <td >{{vo.name}}</td>
                            <td >{{vo.tel}}</td>
                            <td >
                                {{ ('house.houses')|getOne('name', {id: vo_houses}) }}
                            </td>
                            <td >
                                {{ vo.yongjin / 100 * ('db.mconfig')|getOne('value', {name: 'sellrate'}) }}
                            </td>
                            <td >{{ vo.update_time|default('')|date('Y-m-d H:m:s') }}</td>
                            <td>
                                {{ vo.yongjin }} * {{core_global.mconfig({name: 'sellrate', ename: 'msell'})}}% 
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="8" class="tac">没有数据！</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    {{core_manage.page(fx_list|default(''))}}
</section>
{% endblock tableMain %}

{% block promptUl %}
{% endblock %}