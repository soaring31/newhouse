{% extends 'HouseBundle:Houses:lp_list_layout.html.twig' %}
{# 说明
** cfjArea: 所有地区
** houseArea: 当前地区楼盘
** housePrice: 当期楼盘的价格
** cur_area_data: 当前区域数据值
** area_data_area: 当前区域底下地区
** prices： 当前区域价格表
** month_now：本月价格
** month_prev：上月价格
#}

{% set prices = ident.prices|default('') %}

{% set month_now = prices.data[0]|default('') %}

{% set month_prev = prices.data[1]|default('') %}


{% block tkd %}
{% set seoConts = ('db.mconfig_seo')|getAll({status:1,page_type:3,is_delete:0}) %}
{% if seoConts.data[0]|default %}
{{- house_global.tkd({
   type:'3',
   data:seoConts.data[0],
   city:cur_area_data,
}) -}}
{% else %}
{{parent()}}
{% endif %}
{% endblock tkd %}

{% block css %}
    {{ core_global.linkcss('static/' ~ bundlepath ~ '/css/cfj.css') }}
    <style type="text/css">
        .filter-bd {
            border: 0;
        }
    </style>
{% endblock css %}

{# 当前位置 #}
{% block current_houses %}
    <span>{{ cur_area_data|default('') }}房价走势</span>
{% endblock current_houses %}

{% block container %}
    <div class="fj-container">
        <div class="container">
            {% block filters %}
                {{ house_global.filter_cfg({
                    head_data: head_data,
                    action: action
                }) }}
            {% endblock filters %}
            <div class="bd-gray">
                <div class="pl30 clearfix mt20">
                    <div class="chart fl">
                        <div class="fj-tit">{{ cur_area_data|default('') }}房价走势图</div>
                        <div class="chart-con bd-gray">
                            <div id="zst"></div>
                        </div>
                    </div>
                    <div class="data fl" style="margin-bottom: 20px">
                        <div class="fj-tit">参考数据</div>
                        <p>
                            <span class="fl">
                                <span class="big j_newPriceData"> <span class="j_Month"></span>房产均价  <em class="major-c j_newHousePrice"></em></span>
                                <span class="duibi">
                                    环比上月 <em class="major-c j_NHHB">0%</em>  {#<i class="trend i0"></i>#}
                                </span>
                            </span>
                        </p>
                        <p style="margin-top: 10px;">
                            {# 当前城市的简称 #}
                            {% set city = ('db.auth_group_area')|getAll({
                                rulesarea:app.session.get('area')|default(0),
                                pageSize: 1,
                            }) %}
                            查看{{ cur_area_data|default('') }}更多<a href="{{ ('houses/list')|U }}" target="_blank"
                                                                  class="major-c">新房房源</a><span class="j_isOpenHouse">，更多</span><a
                                    href="{{ 'http://'~city.data[0].city~'.house.zhuge.com' }}" target="_blank"
                                    class="major-c j_isOpenHouse">二手房源</a><span class="j_isOpenRent">，更多</span><a
                                    href="{{ 'http://'~city.data[0].city~'.rent.zhuge.com' }}" target="_blank"
                                    class="major-c j_isOpenRent">租房房源</a>
                        </p>
                    </div>
                    <div class="compute fl">
                        <div class="fj-tit">计算工具</div>
                        <ul class="clearfix">
                            <li>
                                <a href="{{ ('tools/index')|U({id: '1'}) }}" target="_blank">
                                    <p class="ico"><i class="font-tools-1"></i>
                                    </p>
                                    <p class="txt">购房能力评估</p>
                                </a>
                            </li>
                            <li>
                                <a href="{{ ('tools/index')|U({id: '5'}) }}" target="_blank">
                                    <p class="ico"><i class="font-tools-6"></i>
                                    </p>
                                    <p class="txt">提前还款计算器</p>
                                </a>
                            </li>
                            <li class="li03">
                                <a href="{{ ('tools/index')|U({id: '6'}) }}" target="_blank">
                                    <p class="ico">
                                        <i class="font-tools-7"></i>
                                    </p>
                                    <p class="txt">税费计算器</p>
                                </a>
                            </li>
                            <li>
                                <a href="{{ ('tools/index')|U({id: '3'}) }}" target="_blank">
                                    <p class="ico">
                                        <i class="font-tools-2"></i>
                                    </p>
                                    <p class="txt">公积金贷款额度评估</p>
                                </a>
                            </li>
                            <li>
                                <a href="{{ ('tools/index')|U({id: '2'}) }}" target="_blank">
                                    <p class="ico">
                                        <i class="font-tools-3"></i>
                                    </p>
                                    <p class="txt">商业贷款</p>
                                </a>
                            </li>
                            <li class="li06">
                                <a href="{{ ('tools/index')|U({id: '3'}) }}" target="_blank">
                                    <p class="ico">
                                        <i class="font-tools-4"></i>
                                    </p>
                                    <p class="txt">公积金贷款</p>
                                </a>
                            </li>
                            <li>
                                <a href="{{ ('tools/index')|U({id: '4'}) }}" target="_blank">
                                    <p class="ico">
                                        <i class="font-tools-5"></i>
                                    </p>
                                    <p class="txt">组合贷款</p>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!--热销楼盘-->
            {% set area_data_area = ('db.area')|getAll({pid: sess_area, checked: 1, pageSize: 9}) %}

            {% if area_data_area.data is defined and area_data_area.pageCount|default(0) != 0 %}
                <div class="fj-area clearfix">
                    {% for item in area_data_area.data %}
                        {% set houseArea = ('house.houses')|getAll({checked: 1, region: item.id|default(''), pageSize: 8, type: 0}) %}
                        <div class="item">
                            <div class="fj-tit">
                                <h3>{{ item.name|default('') }}</h3>
                            </div>
                            <div class="con">
                                <ul>
                                    {% for house in houseArea.data %}
                                        <li class="clearfix">
                                            <i class="ico"></i>
                                            <span class="txt">
                                            <a href="{{ ('houses/detail')|U({id: house.id|default('')}) }}">{{ house.name|default('') }}</a>
                                        </span>
                                            <span class="price">
                                            {{ house_global.if_dj({value: house.dj|default(''), tpl: '%value%%danwei%'}) }}
                                        </span>
                                            <em class="trend i{{ item.trend|default('') }}"></em>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <!--/热销楼盘-->
            <div class="blank10"></div>
            <!-- <div class="fangJia">
                <div class="item_title">
                    <b class="zoushi">city房价走势</b>
                    <b class="loupan">city最惠楼盘</b>
                    <a href="">查看更多&gt;&gt;</a>
                </div>
                <div class="fangjia-box">
                    <div class="fangJia-zoushi">></div>
                    <ul>
                        <li>
                            <div><a href=""><img src=""></a</div>
                            <h5><a href="">城区-楼盘名称润泽公馆</a></h5>
                            <p>均价：<span>73456 元/平</span></p>
                        </li>
                        <li>
                            <div><a href=""><img src=""></a</div>
                            <h5>城区-楼盘名称润泽公馆</h5>
                            <p>均价：<span>73456 元/平</span></p>
                        </li>
                        <li>
                            <div><a href=""><img src=""></a</div>
                            <h5>城区-楼盘名称润泽公馆</h5>
                            <p>均价：<span>73456 元/平</span></p>
                        </li>
                    </ul>
                </div>
            </div> -->
            <!--panel-->
            {% set rexiaoloupantuijian = ('rexiaoloupantuijian')|getPush(5) %}
            {% if rexiaoloupantuijian|default('') %}
                <div class="tj-wrap">
                    <!--title-->
                    <div class="fj-tit">
                        <h3>热销楼盘推荐</h3>
                    </div>
                    <!--/title-->
                    <!--body-->
                    <div class="tj-list bd-gray" data-tag="rexiaoloupantuijian">
                        <div class="blank20"></div>
                        <ul>
                            {% for item in rexiaoloupantuijian %}
                                <li>
                                    <a href="{{ item.url|default('') }}" target="_blank" class="img">
                                        {{- core_global.lazy_img({
                                            src: item.thumb|default(''),
                                            alt: item.name|default(''),
                                            type: 2,
                                            width:200 ,
                                            height: 150
                                        }) -}}
                                    </a>
                                    <p class="clearfix">
                                    <span class="price fr">
                                        {{ house_global.if_dj({value: item.dj|default(''), tpl: '%value%%danwei%'}) }}
                                    </span>
                                        <a href="{{ item.url|default('') }}" title="{{ item.name|default('') }}"
                                           target="_blank">{{ item.name|default('') }}</a>
                                    </p>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <!--/body-->
                </div>
            {% endif %}
            <!--/panel-->
            <div class="blank10"></div>
            <!--panel-->
            {% set fjzs_nknzzz = ('fjzs_nknzzz')|getPush(5) %}
            {% if fjzs_nknzzz|default('') %}
                <div class="tj-wrap">
                    <!--title-->
                    <div class="fj-tit">
                        <h3>你可能正在找</h3>
                    </div>
                    <!--/title-->
                    <!--body-->
                    <div class="tj-list bd-gray" data-tag="fjzs_nknzzz">
                        <div class="blank20"></div>
                        <ul>
                            {% for item in fjzs_nknzzz %}
                                <li>
                                    <a href="{{ item.url|default('') }}" target="_blank" class="img">
                                        {{- core_global.lazy_img({
                                            src: item.thumb|default(''),
                                            alt: item.name|default(''),
                                            type: 2,
                                            width: 200,
                                            height: 150
                                        }) -}}
                                    </a>
                                    <p class="clearfix">
                                    <span class="price fr">
                                        {{ house_global.if_dj({value: item.dj|default(''), tpl: '%value%%danwei%'}) }}
                                    </span>
                                        <a href="{{ item.url|default('') }}" title="{{ item.name|default('') }}"
                                           target="_blank">{{ item.name|default('') }}</a>
                                    </p>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <!--/body-->
                </div>
            {% endif %}
            <!--/panel-->
            <div class="blank30"></div>
        </div>
    </div>
{% endblock container %}

{% block js %}
    <script type="text/javascript" src="{{ asset('static/house/js/echarts.js') }}{{version}}"></script>
    <script type="text/javascript">
        {# 走势图 #}
        {# 横坐标 #}
        {#var zstMouth = [{% if prices.data is defined %}
            {% for item in prices.data %}
                {% if loop.index <= 12 %}
                "{{item.months|default('')|date('m')}}月",
                {% endif %}
            {% endfor %}
        {% endif %}];
         数据
        var dzstDta = [{% if prices.data is defined %}
            {% for item in prices.data %}
                {% if loop.index <= 12 %}
                ["{{item.months|default('')|date('m')}}", {{item.price|default('')}}],
                {% endif %}
            {% endfor %}
        {% endif %}];
        var jsonData = {
            "title": "",
            "series": [{
                "name": "{{cur_area_data|default('')}}房价走势",
                "datatype": "house",
                "data": dzstDta.reverse()
            }],
            "color": ["#ee4433", "#F8CE5D", "#339966"],
            "month_s": zstMouth.reverse()
        };
        seajs.use(['zst', 'lazyload'], function (zst, lazyload) {
        })#}


        seajs.use([], function () {
            $(function () {
                // 获取价格走势
                $.ajax({
                    url: "{{ apiUrl~'/api/v1/trends' }}",
                    type: "post",
                    data: {
                        "city": "{{ city.data[0].name }}",
                        "area":{{ sess_area }}
                    },
                    success: function (xhr) {
                        console.log(xhr)
                        var newData = [];
                        var sellData = [];
                        var date = [];
                        var series = [];
                        var min, max;
                        if (xhr && xhr.code == 200 && xhr.data) {
                            if (xhr.data.new_house_price) {
                                if (xhr.data.new_house_price.tagout_price && xhr.data.new_house_price.tagout_price.length > 0) {

                                    var len = xhr.data.new_house_price.tagout_price.length;
                                    $('.j_expNewHouse .j_price span').html(xhr.data.new_house_price.tagout_price[len - 1].price);
                                    for (var i = 0; i < xhr.data.new_house_price.tagout_price.length; i++) {
                                        date.push(xhr.data.new_house_price.tagout_price[i].date);
                                        newData.push(xhr.data.new_house_price.tagout_price[i].price);
                                    }
                                }
                                $('.j_Month').text(date[date.length - 1].slice(4)+"月");
                                $('.j_newHousePrice').text(Number(newData[newData.length - 1])!=0?newData[newData.length - 1]+'元/平':"暂无");

                                if (xhr.data.new_house_price.percentage > 0) {
                                    $('.j_NHHB').text('涨' + xhr.data.new_house_price.percentage + '%');
                                } else if (xhr.data.new_house_price.percentage < 0) {
                                    $('.j_NHHB').text('降' + (-xhr.data.new_house_price.percentage) + '%');
                                } else {
                                    $('.j_NHHB').html('持平');
                                }
                                $('.j_expNewHouse .j_sellNum span').html(xhr.data.new_house_price.sell_house_count);
                                $('.j_expNewHouse .j_newNum span').html(xhr.data.new_house_price.month_house_count);
                            }

                            if (newData.length <= 0 && sellData.length <= 0) {
                                $('.exp-trend').hide();
                                return;
                            }
                            // 是否开通新房
                            if (newData && newData.length > 0) {
                                min = Math.min.apply(Math, newData);
                                series.push({
                                    data: newData,
                                    type: 'line',
                                    name: '新房',
                                    itemStyle: {
                                        normal: {
                                            color: '#FF5C36'
                                        }
                                    }
                                });
                                $('.trend-title').append('<i style="background:#FF5C36;"></i>新房');
                            }


                            max = parseInt(max + (max - min) / 5);
                            min = parseInt(min - (max - min) / 5);
                            option = {
                                tooltip: {
                                    trigger: 'axis',
                                    textStyle: {
                                        align: "left"
                                    }
                                },
                                grid: {
                                    left: '0',
                                    right: '0',
                                    top: '-10',
                                    bottom: '0',
                                    show: false,
                                    containLabel: true
                                },
                                xAxis: {
                                    type: 'category',
                                    boundaryGap: true,
                                    data: date,
                                    axisLabel: {
                                        interval: 1,
                                        showMaxLabel: true
                                    }
                                },
                                yAxis: {
                                    type: 'value',
                                    axisLabel: {
                                        formatter: '￥{value}' + '元',
                                        textStyle: {
                                            color: "#878787"
                                        }
                                    }
                                },
                                series: series
                            };
                            var myChart = echarts.init(document.getElementById('zst'));
                            myChart.setOption(option);
                        }

                    }
                });
            })
        });
    </script>
{% endblock js %}
