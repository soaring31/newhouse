{% import "HouseBundle:Macro:listMacro.html.twig" as listMacro %}
{% set tpl_extends = 'HouseBundle:Houses:lp_list_layout.html.twig' %}

{% set tpl_extends_data = {
    'search': 'HouseBundle:Houses:search.html.twig',
    'ajax': 'HouseBundle:Clist:houseslist.html.twig'
} %}
{% for k,v in tpl_extends_data %}
    {% if app.request.get(k) or app.request.headers.get(k) %}
        {% set tpl_extends = v %}
    {% endif %}
{% endfor %}
{% extends tpl_extends|default('') %}
{# # 说明
* tpl_models: 区域找房变量
* sort_data_opt:重新排序变量
* tpl_rednum: 红包选项卡高亮
* 以下是筛选区域数据定义
*      1、filter_opt：筛选条件数据
*      2、filter_circle: 开启商圈
*      2、filter_subway: 开启地铁、地铁站
#}
{% block tkd %}
{% set seoConts = ('db.mconfig_seo')|getAll({status:1,page_type:1,is_delete:0}) %}
{% if seoConts.data[0]|default %}
{{- house_global.tkd({
   type:'1',
   data:seoConts.data[0],
   city:cur_area_data,
   pageCount:ident.list.pageCount
}) -}}
{% else %}
{{ parent() }}
{% endif %}
{% endblock tkd %}


{% block css %}
{{core_global.linkcss('static/' ~ bundlepath ~ '/css/quyu.css')}}
{% endblock css %}

{# 当前位置 #}
{% block navi_go %}
    {{- house_global.navi_go({
        city: cur_area_data
    })-}}
{% endblock navi_go %}

{% block container %}

    {# 检索数据源 #}
    {% set cate_data = listMacro.cate_data({
                    tag: 'houses',
                    switch: {
                        cate_circle: 1,
                        cate_line: 1,
                        hxs: 1
                    }
                }).__toString|json_decode %}
    {% set show_selected = 1 %}
    {{ parent() }}
{% endblock container %}

{# 列表头 #}
{% block list_head %}
    {{ parent() }}
{% endblock list_head %}


{# 排序 #}
{% block list_sort %}
    {#{% set sort_data = {#}
        {#def: {#}
            {#title: '默认'#}
        {#},#}
        {#dj: {#}
            {#title: '楼盘价格'#}
        {#},#}
        {#kpdate: {#}
            {#title: '开盘时间'#}
        {#},#}
        {#clicks: {#}
            {#title: '人气',#}
            {#value: 'desc'#}
        {#}#}
    {#} %}#}

    {% set sort_data = {
        def: {
            title: '默认'
        },
        dj: {
            title: '楼盘价格'
        },
        kpdate: {
            title: '开盘时间'
        }
    } %}
    {{ parent() }}
{% endblock list_sort %}

{% block CY_house_list %}
    {% if cy_id %}
        <input type="hidden" value="{{ cy_id|join(',') }}">
        {% set cy_list = ('house.houses')|getAll({id: 'in|'~cy_id|join(',')}) %}
        {{listMacro.cy_list({
            list: cy_list
        })}}
    {% endif %}
{% endblock CY_house_list %}
{# 列表内容 #}
{% block container_houses_list %}
    <div class="lp-list" data-tag="lplist">
        <input type="hidden" value="3" class="page-house-type"/>
        <ul data-list="1">
            {{listMacro.houses_list({
                list: ident.list
            })}}
        </ul>
    </div>
    <script>
        seajs.use([], function() {
            $(function () {
                $('.tags>span').each(function () {
                    if(!$(this).text()){
                        $(this).remove();
                    }
                })
            })
        })
    </script>
{% endblock container_houses_list %}


{# js 楼盘对比，图片懒加载 #}
{% block js %}
    {% if '/houses/list' in (action)|U %}
        <script type="text/javascript">
         seajs.use(['listPjax'], function(listPjax) {
            listPjax.init({
                url: "{{('houses/list')|U}}",
                list: '[data-list]',
                page: '.p-bar a',
                filterShow: '[data-filter-show]',
                next: {
                    url: '{{ ("bundlebindforms/ajax")|U({tpl: "Common:filter_next"}) }}'
                }
            });
         })
        </script>
    {% endif %}
    <script type="text/javascript">

        seajs.use([], function() {
            $(function(){

                // 城区，地铁 切换
                $('.area_btn').on('click',function(){
                    $('.icon-sanjiao').removeClass('now');
                    $(this).find('.icon-sanjiao').addClass('now');
                    $(this).addClass('hover').siblings('a').removeClass('hover');
                    $('.area_box').show();
                    $('.subway_box').hide();
                });
                $('.subway_btn').on('click',function(){
                    $('.icon-sanjiao').removeClass('now');
                    $(this).find('.icon-sanjiao').addClass('now');
                    $(this).addClass('hover').siblings('a').removeClass('hover');
                    $('.subway_box').show();
                    $('.area_box').hide();
                });
                $('body').click(function(){
                    $('#autoSearchList').slideUp(300)
                });
                $('.list-item .pic .list-pre-sale').mouseover(function(){
                    $(this).next('.list-pre-sale-cont').show();
                    $(this).hide();
                }).mouseout(function(){
                    $(this).next('.list-pre-sale-cont').hide();
                    $(this).show();
                });
                $('.list-pre-sale-cont').mouseover(function(){
                    $(this).show();
                }).mouseout(function() {
                    $(this).hide();
                });

                function calcTop(){
                    var eles = $('.list-item .info');
                    eles.each(function(){
                        var height = $(this).height();
                        var top = (180-height)/2;
                        $(this).css('top',top)
                    })
                }
                calcTop();

                function evaluate(a,b){
                    $(a).each(function(){
                        var evaNum = $(this).find(b).val();
                        if(!evaNum){
                            return;
                        }else{
                        var parseIntNum = parseInt(evaNum);
                        var arr = evaNum.split('.');
                        $(this).find('.j_solid-star:lt('+ parseIntNum +')').width('100%').addClass('list-star-anim');
                        if(arr[1]){
                            w = arr[1]*10 + '%';
                            $(this).find('.j_solid-star:eq('+ parseIntNum +')').width(w).addClass('list-star-anim');
                        }
                        }
                    })
                }
                evaluate('.list-item','.j_pingfen');

                function telTrans(){
                    var listItems = $('.list-item');
                    listItems.each(function(){
                        var finalStr = '';
                        var tel = $(this).find('.j_tel').text();
                        var telArr = tel.trim().split(',');
                        var str = telArr[0].split('');
                        str.splice(3,0,' ');
                        str.splice(7,0,' ');
                        var useStr = str.join('');
                        if(telArr[1]){
                            finalStr = useStr + ' 转 ' + telArr[1];
                        }else{
                            finalStr = useStr;
                        }
                        $(this).find('.j_tel').text(finalStr);

                    })
                }
                telTrans();

                function roomDataTrans(){
                    var charObj = {
                        "1":"一",
                        "2":"二",
                        "3":"三",
                        "4":"四",
                        "5":"五",
                        "6":"六",
                        "7":"七",
                        "8":"八",
                        "9":"九",
                    }
                    var listItems = $('.list-item');
                    listItems.each(function(){
                        var eles = $(this).find('.j_roomdata a');

                        if(!eles){
                            return
                        }else{
                            var arr = [];
                            var roomArr = [];
                            var areaArr = [];
                            var obj = {};
                            var result = [];
                            var results = [];
                            var roomStr = '';
                            var areaStr = '';
                            var finalStr = '';
                            eles.each(function(){
                                arr.push($(this).text().trim())
                            })

                            arr.forEach(function(item){
                                if(item.indexOf('室') != -1){//如果存在‘室’
                                    var reg = /([1-9][0-9]*)+(\.[0-9]{1,2})?/g
                                    var matchStrArr = item.match(reg);
                                    roomArr.push(matchStrArr.shift());
                                    areaArr.push(matchStrArr.pop());
                                }else{//如果只有面积
                                    var reg = /([1-9][0-9]*)+(\.[0-9]{1,2})?/g
                                    var matchStrArr = item.match(reg);
                                    areaArr.push(matchStrArr.pop());
                                }
                            })
                            for(var i = 0; i < roomArr.length; i++){
                                if(!obj[roomArr[i]]){
                                    obj[roomArr[i]] = 1;
                                    result.push(roomArr[i]);
                                }
                            }
                            if(result.length > 0){
                                results = result.sort();
                            }
                            if(areaArr.length > 0){
                                var maxAreaNum = Math.max.apply(null,areaArr);
                                var minAreaNum = Math.min.apply(null,areaArr);
                            }
                            results.forEach(function(item){
                                roomStr += charObj[item]+'居/';
                            })
                            roomStr = roomStr.substring(0, roomStr.length-1);
                            if(minAreaNum && maxAreaNum){
                                areaStr = minAreaNum + '~' + maxAreaNum + '平米';
                                if(minAreaNum == maxAreaNum){
                                    areaStr = minAreaNum + '平米';
                                }
                            }
                            if(roomStr){
                                finalStr = roomStr;
                                if(areaStr){
                                    finalStr = roomStr + ' —— ' + areaStr;
                                }
                            }else{
                                finalStr = areaStr;
                            }
                            $(this).find('.j_roomdata').html(finalStr);
                        }
                    })
                }
                roomDataTrans()
            })
        });
    </script>
    {#<script type="text/javascript" src="{{asset('static/house/js/search.js')}}"></script>#}
{% endblock js %}
